{% extends 'base.html' %}
{% load i18n %}
{% block title %}{% translate 'Divided Differences Method' %} - {% translate 'Divided Differences' %}{% endblock %}
{% block content %}
    {% load static %}

    <div class="container-sm p-5">
        <div class="row pb-0 pt-lg-5 align-items-center rounded-3 mb-5 mb-5">
            <div class="col-lg-12">
                <h2 class="display-4 fw-bold lh-1s">{% translate 'Método Diferencias Divididas' %}</h2>
                <p class="lead py-5">
                    {% translate 'El método de diferencias divididas es una técnica empleada en interpolación numérica para encontrar un polinomio que pase a través de un conjunto de puntos dados. Este método se basa en calcular las diferencias sucesivas entre los valores de la función evaluados en puntos específicos, dividiendo estas diferencias por la distancia entre los puntos correspondientes. El proceso comienza con un conjunto de datos, generalmente puntos que consisten en pares de valores de una variable independiente y su correspondiente valor de la función. El primer paso consiste en calcular la diferencia dividida de primer orden, que se obtiene tomando la diferencia entre los valores de la función de dos puntos consecutivos y dividiéndola por la distancia entre los puntos en el eje de la variable independiente' %}
                </p>
                <div class="d-grid gap-2 d-md-flex justify-content-md-start mb-4 mb-lg-3">
                    <button type="button" class="btn btn-primary btn-lg px-4 me-md-2 fw-bold"
                            onclick="showCalculator()">{% translate 'Graphing Calculator' %}
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-lg px-4" onclick="showExplanation()">
                        {% translate 'Explanation' %}
                    </button>
                </div>
            </div>
        </div>

        <div class="py-3"></div>

        <!-- Hidden calculator section -->
        <div id="calculator" style="display: none;" class="mt-5">
            <h3 class="mb-5">{% translate 'Calculadora Diferencias Divididas' %}</h3>
            <form class="mb-5 p-4 bg-light rounded-3 shadow" id="calculatorForm">

                <!-- Valores de x -->
                <div class="mb-3">
                    <div class="col-md-12 col-sm-6 mb-3">
                        <label for="input_x" class="form-label">{% translate 'Valores de x' %}:</label>
                        <input type="text" class="form-control" id="input_x" required>
                    </div>
                </div>

                <!-- Valores de f(x) -->
                <div class="row">
                    <div class="col-sm-6 mb-3">
                        <label for="input_y" class="form-label">{% translate 'Valores de f(x)' %}:</label>
                        <input type="text" class="form-control" id="input_y" step="any" value="3" required>
                    </div>
                </div>

                <!-- Botón para agregar puntos -->
                <button type="button" class="btn btn-secondary mt-2" id="agregar_punto_btn">
                    {% translate 'Agregar punto' %}
                </button>

                <!-- Lista de puntos ingresados -->
                <div class="mb-3">
                    <label class="form-label">{% translate 'Puntos ingresados' %}:</label>
                    <ul id="puntos_list" class="list-group"></ul>
                </div>

                <!-- Grado de polinomio y X a interpolar-->
                <div class="row">
                    <div class="col-sm-6 mb-3">
                        <label for="grado" class="form-label">{% translate 'Grado del polinomio (ng)' %}:</label>
                        <input type="number" class="form-control" id="grado" value="1" min="1" required>
                    </div>

                    <!-- Valor de x a interpolar -->
                    <div class="col-sm-6 mb-3">
                        <label for="x_interpolar" class="form-label">{% translate 'Valor de x a interpolar' %}:</label>
                        <input type="number" class="form-control" id="x_interpolar" step="any" required>
                    </div>
                </div>

                <!-- Botón para calcular la interpolación -->
                <button type="submit" class="btn btn-lg btn-primary mt-2" id="calculateButton">
                    <span class="spinner-border spinner-border-sm me-2" role="status" style="display: none;" id="loadingSpinner"></span>
                    <span id="buttonText">{% translate 'Calcular interpolación' %}</span>
                </button>
            </form>

            <!-- Resultados -->
            <div id="messageContainer"></div>

            <!-- Tabla de resultados -->
            <div id="results-container" style="display: none;">
                <h4>{% translate 'Results' %}</h4>
                <table id="resultsTable" class="table table-bordered">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>{% translate 'Punto (x, f(x))' %}</th>
                            <th>{% translate 'Diferencias divididas' %}</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <!-- Hidden extensive explanation section -->
        <div id="explanation" class="mt-4 rounded-3">
            <h3 class="pb-3">{% translate "Explicación Método Diferencias Divididas" %}</h3>
            <p class="lead">
                {% translate "<strong>1. Preparar los datos:</strong><br><br>" %}
                {% translate "Supón que se tiene un conjunto de puntos dados (\( x_0 \), \( y_0 \)), (\( x_1 \), \( y_1 \)), (\( x_n \), \( y_n \)), donde \( x_i \) son los valores de la variable dependiente y \( y_i \) = f(\( y_i \)) son los valores de la función.<br><br>" %}

                {% translate "<strong>2. Cálculo de las diferencias divididas:</strong><br><br>" %}
                {% translate "Diferencias divididas primer orden: Se calcula con la fórmula: <br>" %}
                \[
                f[x_i, x_{i+1}] = \frac{f(x_{i+1}) - f(x_i)}{x_{i+1} - x_i}
                \]
                {% translate "Esta fórmula calcula la tasa de cambio promedio entre los valores de la función en dos puntos consecutivos \( x_i \) y \( x_{i+1} \).<br><br>" %}

                {% translate "Diferencias divididas segundo orden: Se calcula utilizando las diferencias divididas de primer orden ya obtenidas: <br>" %}
                \[
                f[x_i, x_{i+1}, x_{i+2}] = \frac{f(x_{i+1}, x_{i+2}) - f(x_i, x_{i+1})}{x_{i+2} - x_i}
                \]

                {% translate "Generalización para diferencias divididas de orden n: se sigue el mismo principio de cálculo recursivo, usando las diferencias divididas de orden n - 1 y la fórmula general: <br><br>" %}
                \[
                f[x_i, x_{i+1}, ..., x_{i+n}] = \frac{f(x_{i+1}, ..., x_{i+n}) - f(x_i, ..., x_{i+n-1})}{x_{i+n} - x_i}
                \]
                {% translate "<strong>3. Construcción polinomio de interpolación: </strong><br><br>" %}
                {% translate "Una vez que se han calculado todas las diferencias divididas, el polinomio de interpolación se construye de la siguiente manera: .<br>" %}
                \[
                P(x) = f[x_0] + (x - x_0)f[x_0, x_1] + (x - x_0)(x - x_1)f[x_0, x_1, x_2] + ... 
                \]
                {% translate "<strong>4. Evaluación del polinomio: </strong><br><br>" %}
                {% translate "Para evaluar el polinomio en un valor x dado, se sustituye x en la expresión del polinomio P(x). Esta forma de evaluación es eficiente debido a que la estructura del polinomio permite agregar puntos de manera incremental sin necesidad de recalcular todo el polinomio desde cero." %}
            </p>
        </div>

       <script>

            function showCalculator() {
                document.getElementById('explanation').style.display = 'none';
                document.getElementById('calculator').style.display = 'block';
            }

            function showExplanation() {
                document.getElementById('calculator').style.display = 'none';
                document.getElementById('explanation').style.display = 'block';
            }

            document.getElementById("calculatorForm").addEventListener("submit", function (event) {
                event.preventDefault();
                calculateAndGraph();
            });

            function setLoadingState(isLoading) {
                const button = document.getElementById("calculateButton");
                const spinner = document.getElementById("loadingSpinner");
                const buttonText = document.getElementById("buttonText");

                button.disabled = isLoading;
                spinner.style.display = isLoading ? "inline-block" : "none";
                buttonText.textContent = isLoading ? "{% translate 'Calculating...' %}" : "{% translate 'Calculate and Graph' %}";
            }

            function clearPreviousResults() {
                // Clear tables
                document.getElementById("resultsTable").querySelector("tbody").innerHTML = "";

                // Clear messages
                document.getElementById("messageContainer").innerHTML = "";

                // Clear plots
                Plotly.purge('plot-container');

                // Hide results and graphs containers
                document.getElementById("results").style.display = "none";
                document.getElementById("graphs-container").style.display = "none";
            }

            function calculateAndGraph() {
                clearPreviousResults();

                const equation = document.getElementById("equation").value;
                const a = document.getElementById("intervalA").value;
                const b = document.getElementById("intervalB").value;
                const tolerance = document.getElementById("tolerance").value;
                const maxIterations = document.getElementById("maxIterations").value;
                const p0 = document.getElementById("p0").value;
                const p1 = document.getElementById("p1").value;

                setLoadingState(true);

                const url = `/calculate-newton-raphson-method/?equation=${encodeURIComponent(equation)}&a=${a}&b=${b}&tol=${tolerance}&maxIterations=${maxIterations}&p0=${p0}&p1=${p1}`;

                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.error) {
                            throw new Error(data.message);
                        }

                        const plotData = JSON.parse(data.graph);

                        // Update the layout to be responsive
                        plotData.layout.autosize = true;
                        plotData.layout.height = undefined;
                        plotData.layout.width = undefined;

                        const config = {
                            responsive: true,
                            displayModeBar: true,
                            scrollZoom: true,
                            showLink: false,
                            displaylogo: false,
                            modeBarButtonsToAdd: ['drawopenpath', 'eraseshape'],
                            modeBarButtonsToRemove: ['lasso2d']
                        };

                        Plotly.newPlot('plot-container', plotData.data, plotData.layout, config);

                        document.getElementById("graphs-container").style.display = "block";
                        document.getElementById("results").style.display = "block";
                        console.log(data)

                        displayResults(data);
                    })
                    .catch(error => {
                        console.error("Error:", error);
                        document.getElementById("messageContainer").innerHTML = `
                            <div class="alert alert-danger">
                                <strong>Error:</strong> ${error.message}
                            </div>`;
                        document.getElementById("results").style.display = "block";
                    })
                    .finally(() => {
                        setLoadingState(false);
                    });
            }

            function displayResults(data) {
                // Display regular Regula Falsi results
                populateResultsTable(
                    "resultsTable",
                    "messageContainer",
                    data.results.results
                );
            }

            function populateResultsTable(tableId, messageId, results) {
                const table = document.getElementById(tableId);
                const tbody = table.querySelector("tbody");
                tbody.innerHTML = "";

                const messageContainer = document.getElementById(messageId);
                messageContainer.innerHTML = "";

                if (results.converged) {
                    messageContainer.innerHTML = `
                        <div class="alert alert-success">
                            <strong>{% translate 'Root found' %}:</strong> ${results.root.toFixed(6)}
                        </div>`;
                } else {
                    messageContainer.innerHTML = `
                        <div class="alert alert-warning">
                            {% translate 'Method did not converge within the maximum number of iterations' %}.
                        </div>`;
                }

                console.log(results)

                results.iterations.forEach(iter => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${iter.iteration}</td>
                        <td>${iter.p0.toFixed(6)}</td>
                        <td>${iter.p1.toFixed(6)}</td>
                        <td>${iter['f(p0)'].toFixed(6)}</td>
                        <td>${iter['f(p1)'].toFixed(6)}</td>
                    `;
                    tbody.appendChild(row);
                });
            }

            

        </script>

    </div>
{% endblock %}
